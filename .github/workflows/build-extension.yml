name: Build Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(grep -oP '"version":\s*"\K[^"]+' manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extension version: $VERSION"

      - name: Prepare build directory
        run: |
          mkdir -p build/tabgo

          # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
          cp manifest.json build/tabgo/
          cp -r background build/tabgo/
          cp -r content build/tabgo/
          cp -r popup build/tabgo/
          cp -r options build/tabgo/
          cp -r pages build/tabgo/
          cp -r assets build/tabgo/

          # æ˜¾ç¤ºæ‰“åŒ…å†…å®¹
          echo "=== Build contents ==="
          ls -la build/tabgo/
          echo "=== Assets structure ==="
          find build/tabgo/assets -type f

      - name: Create ZIP package
        run: |
          cd build
          zip -r ../tabgo-${{ steps.version.outputs.version }}.zip tabgo/
          cd ..

          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          echo "=== Package created ==="
          ls -lh tabgo-*.zip
          unzip -l tabgo-*.zip | head -20

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tabgo-extension
          path: tabgo-*.zip
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: tabgo-*.zip
          body: |
            ## TabGo v${{ steps.version.outputs.version }}

            ### å®‰è£…æ–¹æ³•
            1. ä¸‹è½½ `tabgo-${{ steps.version.outputs.version }}.zip`
            2. è§£å‹åˆ°æœ¬åœ°ç›®å½•
            3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè®¿é—® `chrome://extensions/`
            4. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
            5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
            6. é€‰æ‹©è§£å‹åçš„ç›®å½•

            ### åŠŸèƒ½ç‰¹æ€§
            - è‡ªåŠ¨æ ‡ç­¾é¡µåˆ†ç»„
            - ç™½åå•ç®¡ç†
            - åˆ†ç»„åˆ«åç®¡ç†
            - å­åŸŸååˆ†ç»„
            - æ‰‹é£ç´æ¨¡å¼

            ---
            ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
